name: Publish Resume

on:
  push:
    branches:
      - main

defaults:
  run:
    working-directory: .

jobs:
  build_resume:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Get Latest Tag
        id: get_tag
        run: |
          # Fetch all tags
          git fetch --tags
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 || echo "v0")
          echo "Latest Tag: $LATEST_TAG"
          echo "current_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Increment Version
        id: increment_version
        run: |
          # Extract version number from tag (assuming format like v1, v2, etc.)
          VERSION=$(echo "${{ steps.get_tag.outputs.current_version }}" | sed 's/^v//')
          echo "Current Version: $VERSION"
          NEXT_VERSION=$((VERSION + 1))
          NEXT_TAG="v$NEXT_VERSION"
          echo "Next Tag: $NEXT_TAG"
          echo "version=$NEXT_TAG" >> $GITHUB_OUTPUT

      - name: Convert to PDF
        uses: xu-cheng/latex-action@v4
        with:
          root_file: Ayush_Jaipuriyar.tex
          # Enable caching for faster builds
          latexmk_use_lualatex: false  # or true if using LuaLaTeX
          latexmk_shell_escape: false

      - name: Check PDF exists
        run: |
          if [ ! -f Ayush_Jaipuriyar.pdf ]; then
            echo "PDF not generated"
            exit 1
          fi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v5
        with:
          name: resume-pdf
          path: Ayush_Jaipuriyar.pdf

      - name: Tag the release
        run: |
          new_tag=${{ steps.increment_version.outputs.version }}
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git tag $new_tag
          git push origin $new_tag

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.4.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.increment_version.outputs.version }}
          files: Ayush_Jaipuriyar.pdf

  deploy:
    runs-on: ubuntu-latest
    needs: build_resume
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Download PDF
        uses: actions/download-artifact@v6
        with:
          name: resume-pdf

      - name: Create Pages directory
        run: |
          mkdir -p public
          cp Ayush_Jaipuriyar.pdf public/
          echo '<html><body><a href="Ayush_Jaipuriyar.pdf">Download Resume PDF</a></body></html>' > public/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
